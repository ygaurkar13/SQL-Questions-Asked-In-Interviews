-- -- You are given a table of product launches by company by year. Write a query to count the net difference between the number of products companies launched in 2020 with the number of products companies launched in the previous year. Output the name of the companies and a net difference of net products released for 2020 compared to the previous year.

-- ğŸ” By solving this, you'll learn how to handle aggregation function. Give it a try! ğŸ‘‡

-- ğ’ğœğ¡ğğ¦ğš ğšğ§ğ ğƒğšğ­ğšğ¬ğğ­:
-- CREATE TABLE car_launches(year int, company_name varchar(15), product_name varchar(30));

-- INSERT INTO car_launches VALUES(2019,'Toyota','Avalon'),(2019,'Toyota','Camry'),
-- (2020,'Toyota','Corolla'),(2019,'Honda','Accord'),(2019,'Honda','Passport'),(2019,'Honda','CR-V'),
-- (2020,'Honda','Pilot'),(2019,'Honda','Civic'),(2020,'Chevrolet','Trailblazer'),(2020,'Chevrolet','Trax'),
-- (2019,'Chevrolet','Traverse'),(2020,'Chevrolet','Blazer'),(2019,'Ford','Figo'),(2020,'Ford','Aspire'),
-- (2019,'Ford','Endeavour'),(2020,'Jeep','Wrangler')

-- solution :
    -- using ctes here would cost more table scans so using case and sum only in single table scan this is done

        select
            company_name
            ,sum(case when year=2020 then 1
                case when year=2019 then -1
                else 0 end) as NET_DIFFERENCE
        from 
            car_launches
        where year in (2020,2019)
        order by company_name


    -- using cte:
        with products_launched_yearly_CTE as (
            select 
                company_name
                ,year
                ,count(product_name) as products_launched_per_year
            from car_launches 
            group by company_name ,year
        )
        select 
            ply.company_name,
            coalesce(plx.products_launched_per_year,0) -
                coalesce(ply.products_launched_per_year) as NET_DIFFERENCE
        
        from products_launched_yearly_CTE as ply
        left join products_launched_yearly_CTE as plx
            on ply.company_name =plx.company_name 
        and plx.year=2020
        where ply.year=2019;